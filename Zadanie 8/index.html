<!doctype html>
<html>
<head>
<style>
    * {
        touch-action: manipulation;
    }

    html {
        min-height: 100%;
        position: relative;
    }

    html, body {
        width:  100%;
        height: 100%;
        margin: 0;
    }

    #buttons {
        width: 100%;
        height: 20%;
    }

    #request {
        width: 100%;
        height: 90%;
    }

    .disable-dbl-tap-zoom {
        touch-action: manipulation;
    }

    canvas {
        width: 100%;
    }

</style>
    <meta name="viewport" content="width=device-width">
</head>

<body class="disable-dbl-tap-zoom">
    <canvas id="canvas"></canvas><br>
    <div id="buttons">
        <button id="request" type="button">Start Game</button> 
    </div>
    <script>
        function drawBoard() {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            ctx.fillStyle = "grey";
            ctx.rect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fill();
        }

        function moveAndDrawPlatform(step) {
            platformX += step;

            ctx.beginPath();
            ctx.fillStyle = "yellow";
            ctx.rect(platformX, platformY, platformWidth, platformHeight);
            ctx.fill();
        }

        function draw() {
            drawBoard();

            moveAndDrawPlatform(0);

            if (leftKeyDown) {
                if (platformX > 0) {
                    moveAndDrawPlatform(-step); 
                }
            } else if (rightKeyDown) {
                if (platformX < (ctx.canvas.width - platformWidth)) {
                    moveAndDrawPlatform(step);
                }
            }

            requestAnimationFrame(draw);
        }

        function changeCtxSize() {
            ctx.canvas.width = window.innerWidth;
            ctx.canvas.height = window.innerHeight * 0.8;

            platformX = ctx.canvas.width / 2 - 50;
            platformY = ctx.canvas.height - platformYOffset;

            console.log(platformX)
            console.log(platformY)
        }

        function checkKey(e) {
            // if (isTargetHit()) {
            //     return
            // }

            e = e || window.event;
            if (e.keyCode == '37') { // left arrow
                e.preventDefault();
                leftKeyDown = true
                rightKeyDown = false
            } else if (e.keyCode == '39') { // right arrow
                e.preventDefault();
                rightKeyDown = true
                leftKeyDown = false
            }
        }

        function stopMove(e) {
            if (e.keyCode == '37') {
                leftKeyDown = false;
            } else if (e.keyCode == '39') {
                rightKeyDown = false;
            }
        }

        function handleOrientation(event) {
            if (window.orientation == "90" || window.orientation == "-90") {
                if (event.beta < -8) {
                    leftKeyDown = true
                } else if (event.beta > 8) {
                    rightKeyDown = true
                } else {
                    leftKeyDown = false
                    rightKeyDown = false
                }
            } else {    
                if (event.gamma < -8) {
                    leftKeyDown = true
                } else if (event.gamma > 8) {
                    rightKeyDown = true
                } else {
                    leftKeyDown = false
                    rightKeyDown = false
                }
            }
        };

        document.onkeydown = checkKey;
        document.onkeyup = stopMove
        window.onresize = changeCtxSize;

        function permission () {
            if (typeof(DeviceOrientationEvent) !== "undefined" && typeof(DeviceOrientationEvent.requestPermission) === "function" ) {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                    if (response == "granted") {
                        window.addEventListener("deviceorientation", handleOrientation)
                    }
                })
                    .catch(console.error)
            } else {
                window.addEventListener("deviceorientation", handleOrientation);
            }

            draw();
        }

        document.getElementById("request").addEventListener("click", permission);

        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        
        ctx.canvas.width = window.innerWidth;
        ctx.canvas.height = window.innerHeight * 0.8;

        var platformYOffset = 30;
        var platformWidth = 120;
        var platformHeight = 15;
        var platformX = ctx.canvas.width / 2 - (platformWidth / 2);
        var platformY = ctx.canvas.height - platformYOffset;

        var leftKeyDown = false;
        var rightKeyDown = false;
        var step = 10;
    </script>
</body>

</html>